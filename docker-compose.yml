services:
  mariadb:
    image: mariadb:11.7.2
    container_name: abs-mariadb
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
      - '--init-connect=SET NAMES utf8mb4'
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - moodle_network

  moodle:
    image: abstechnology/moodle-standard:develop-5.0.2-plus-lb
    container_name: abs-moodle
    ports:
      - "80:8080"
      - "443:8443"
    environment:
      # Moodle Admin Configuration
      - MOODLE_USERNAME=${MOODLE_USERNAME}
      - MOODLE_PASSWORD=${MOODLE_PASSWORD}
      - MOODLE_EMAIL=${MOODLE_EMAIL}
      
      # Moodle Site Configuration
      - MOODLE_SITE_NAME=${MOODLE_SITE_NAME}
      - MOODLE_SITE_FULLNAME=${MOODLE_SITE_FULLNAME}
      - MOODLE_SITE_SHORTNAME=${MOODLE_SITE_SHORTNAME}
      - MOODLE_CRON_MINUTES=${MOODLE_CRON_MINUTES}
      
      # Database Configuration
      - MOODLE_DATABASE_TYPE=${MOODLE_DATABASE_TYPE}
      - MOODLE_DATABASE_HOST=${MOODLE_DATABASE_HOST}
      - MOODLE_DATABASE_PORT_NUMBER=${MOODLE_DATABASE_PORT_NUMBER}
      - MOODLE_DATABASE_USER=${MARIADB_USER}
      - MOODLE_DATABASE_PASSWORD=${MARIADB_PASSWORD}
      - MOODLE_DATABASE_NAME=${MARIADB_DATABASE}
      
      # PHP Configuration Limits
      - PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT}
      - PHP_MAX_INPUT_VARS=${PHP_MAX_INPUT_VARS}
      - PHP_MAX_FILE_UPLOADS=${PHP_MAX_FILE_UPLOADS}
      - PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE}
      - PHP_UPLOAD_MAX_FILESIZE=${PHP_UPLOAD_MAX_FILESIZE}
      - PHP_MAX_EXECUTION_TIME=${PHP_MAX_EXECUTION_TIME}
      - PHP_MAX_INPUT_TIME=${PHP_MAX_INPUT_TIME}
      - PHP_OUTPUT_BUFFERING=${PHP_OUTPUT_BUFFERING}
      - PHP_DEFAULT_SOCKET_TIMEOUT=${PHP_DEFAULT_SOCKET_TIMEOUT}
      
      # PHP Error Reporting
      - PHP_ERROR_REPORTING=${PHP_ERROR_REPORTING}
      - PHP_DISPLAY_ERRORS=${PHP_DISPLAY_ERRORS}
      - PHP_LOG_ERRORS=${PHP_LOG_ERRORS}
      
      # PHP-FPM Pool Settings
      - PHP_FPM_PM=${PHP_FPM_PM}
      - PHP_FPM_MAX_CHILDREN=${PHP_FPM_MAX_CHILDREN}
      - PHP_FPM_START_SERVERS=${PHP_FPM_START_SERVERS}
      - PHP_FPM_MIN_SPARE_SERVERS=${PHP_FPM_MIN_SPARE_SERVERS}
      - PHP_FPM_MAX_SPARE_SERVERS=${PHP_FPM_MAX_SPARE_SERVERS}
      - PHP_FPM_MAX_REQUESTS=${PHP_FPM_MAX_REQUESTS}
      
      # Apache Configuration
      - APACHE_TIMEOUT=${APACHE_TIMEOUT}
      - APACHE_KEEPALIVE=${APACHE_KEEPALIVE}
      - APACHE_MAX_KEEPALIVE_REQUESTS=${APACHE_MAX_KEEPALIVE_REQUESTS}
      - APACHE_KEEPALIVE_TIMEOUT=${APACHE_KEEPALIVE_TIMEOUT}
      - APACHE_LOG_LEVEL=${APACHE_LOG_LEVEL}
      - APACHE_START_SERVERS=${APACHE_START_SERVERS}
      - APACHE_MIN_SPARE_SERVERS=${APACHE_MIN_SPARE_SERVERS}
      - APACHE_MAX_SPARE_SERVERS=${APACHE_MAX_SPARE_SERVERS}
      - APACHE_MAX_REQUEST_WORKERS=${APACHE_MAX_REQUEST_WORKERS}
      - APACHE_MAX_CONNECTIONS_PER_CHILD=${APACHE_MAX_CONNECTIONS_PER_CHILD}
      - APACHE_SERVER_LIMIT=${APACHE_SERVER_LIMIT}
      - APACHE_HTTP_PORT=${APACHE_HTTP_PORT}
      - APACHE_HTTPS_PORT=${APACHE_HTTPS_PORT}
      
      # SSL Configuration
      - SSL_CERT_FILE=${SSL_CERT_FILE}
      - SSL_KEY_FILE=${SSL_KEY_FILE}
      
      # System Configuration
      - SYSTEM_TIMEZONE=${SYSTEM_TIMEZONE}
      
      # MariaDB Connection Configuration
      - MARIADB_HOST=${MOODLE_DATABASE_HOST}
      - MARIADB_PORT_NUMBER=${MOODLE_DATABASE_PORT_NUMBER}
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      
      # Proxy Configuration
      - MOODLE_REVERSEPROXY=${MOODLE_REVERSEPROXY}
      - MOODLE_SSLPROXY=${MOODLE_SSLPROXY}
      - MOODLE_DOMAIN=${MOODLE_DOMAIN}
      
      # Container Configuration
      - CONTAINER_NAME=${CONTAINER_NAME}
      - CONTAINER_TIMEZONE=${CONTAINER_TIMEZONE}
      - CONTAINER_LOG_LEVEL=${CONTAINER_LOG_LEVEL}
      
      # Support Configuration
      - SUPPORT_EMAIL=${SUPPORT_EMAIL}
      - SUPPORT_WEBSITE=${SUPPORT_WEBSITE}
      - SUPPORT_DOCUMENTATION=${SUPPORT_DOCUMENTATION}
      
    volumes:
      - ./data/moodle:/var/www/html
      - ./data/moodledata:/var/www/moodledata
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "sh", "-c", "if [ \"$$MOODLE_SSLPROXY\" = \"yes\" ]; then curl -f -k https://localhost:8443/login/index.php; else curl -f http://localhost:8080/login/index.php; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - moodle_network

networks:
  moodle_network:
    driver: bridge

volumes:
  mariadb_data:
