services:
  mariadb:
    image: mariadb:11.7.2
    container_name: abs-mariadb
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
      - '--init-connect=SET NAMES utf8mb4'
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - moodle_network

  moodle:
    image: abstechnology/moodle-core:4.5.7-plus
    container_name: abs-moodle
    ports:
      - "80:8080"
      - "443:8443"
    environment:
      # Moodle Admin Configuration
      - MOODLE_USERNAME=${MOODLE_USERNAME}
      - MOODLE_PASSWORD=${MOODLE_PASSWORD}
      - MOODLE_EMAIL=${MOODLE_EMAIL}
      
      # Moodle Site Configuration
      - MOODLE_SITE_NAME=${MOODLE_SITE_NAME}
      - MOODLE_SITE_FULLNAME=${MOODLE_SITE_FULLNAME}
      - MOODLE_SITE_SHORTNAME=${MOODLE_SITE_SHORTNAME}
      - MOODLE_CRON_MINUTES=${MOODLE_CRON_MINUTES}
      
      # Database Configuration
      - MOODLE_DATABASE_TYPE=${MOODLE_DATABASE_TYPE}
      - MOODLE_DATABASE_HOST=${MOODLE_DATABASE_HOST}
      - MOODLE_DATABASE_PORT_NUMBER=${MOODLE_DATABASE_PORT_NUMBER}
      - MOODLE_DATABASE_USER=${MARIADB_USER}
      - MOODLE_DATABASE_PASSWORD=${MARIADB_PASSWORD}
      - MOODLE_DATABASE_NAME=${MARIADB_DATABASE}
      
      # PHP Configuration Limits
      - PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT}
      - PHP_MAX_INPUT_VARS=${PHP_MAX_INPUT_VARS}
      - PHP_MAX_FILE_UPLOADS=${PHP_MAX_FILE_UPLOADS}
      - PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE}
      - PHP_UPLOAD_MAX_FILESIZE=${PHP_UPLOAD_MAX_FILESIZE}
      - PHP_MAX_EXECUTION_TIME=${PHP_MAX_EXECUTION_TIME}
      
      # MariaDB Connection Configuration
      - MARIADB_HOST=${MOODLE_DATABASE_HOST}
      - MARIADB_PORT_NUMBER=${MOODLE_DATABASE_PORT_NUMBER}
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      
      # Proxy Configuration
      - MOODLE_REVERSEPROXY=${MOODLE_REVERSEPROXY}
      - MOODLE_SSLPROXY=${MOODLE_SSLPROXY}
      
    volumes:
      - ./data/moodle:/var/www/html
      - ./data/moodledata:/var/www/moodledata
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "sh", "-c", "if [ \"$$MOODLE_SSLPROXY\" = \"yes\" ]; then curl -f -k https://localhost:8443/login/index.php; else curl -f http://localhost:8080/login/index.php; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - moodle_network

networks:
  moodle_network:
    driver: bridge

volumes:
  mariadb_data:
