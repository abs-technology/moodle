# Apache HTTP Server Configuration for Absi Technology Moodle
# This file is copied into /etc/apache2/apache2.conf inside the Docker container.

# Global configuration
ServerRoot "/etc/apache2"
ServerName {{WEB_SERVER_NAME}}

# Basic configuration
PidFile /var/run/apache2/apache2.pid

# Listen on configurable ports for non-root user
Listen {{APACHE_HTTP_PORT}}
Listen {{APACHE_HTTPS_PORT}}

# Load balancer optimizations (configurable via environment variables)
UseCanonicalName Off
UseCanonicalPhysicalPort Off
Timeout {{APACHE_TIMEOUT}}
KeepAlive {{APACHE_KEEPALIVE}}
MaxKeepAliveRequests {{APACHE_MAX_KEEPALIVE_REQUESTS}}
KeepAliveTimeout {{APACHE_KEEPALIVE_TIMEOUT}}

# Worker configuration (configurable via environment variables)
User {{WEB_SERVER_DAEMON_USER}}
Group {{WEB_SERVER_DAEMON_GROUP}}

# Global logging configuration
ErrorLog /dev/stderr
LogLevel {{APACHE_LOG_LEVEL}}

# Define log format
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

# Load balancer log format with X-Forwarded headers
LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Forwarded-Proto}i\"" combined_lb

# Access log configuration
CustomLog /dev/stdout combined_lb

# Other vhosts access log
Include /etc/apache2/conf-available/other-vhosts-access-log.conf

# Document root (configurable via environment variables)
DocumentRoot "{{MOODLE_DIR}}"
<Directory "{{MOODLE_DIR}}">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# PHP-FPM configuration (configurable via environment variables)
<FilesMatch \.php$>
    SetHandler "proxy:unix:{{PHP_FPM_SOCKET}}|fcgi://localhost"
</FilesMatch>

# Include additional configuration files
IncludeOptional /etc/apache2/conf-enabled/*.conf
IncludeOptional /etc/apache2/sites-enabled/*.conf

# Access control
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

# Directory for Apache modules.
# Ensure 'a2enmod' is used in Dockerfile to link these.
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include site-specific configuration files.
# The 000-default.conf will be linked here by 'a2ensite' in Dockerfile.
IncludeOptional sites-enabled/*.conf

# HTTPoxy Fix (important security measure)
<IfModule mod_headers.c>
    RequestHeader unset Proxy
</IfModule>

# Server Tokens (for security, hide Apache version)
ServerTokens Prod

# Mutex configuration
Mutex file:/var/lock/apache2 default

# DefaultType
DefaultType None

# MPM configuration optimized for load balancing (configurable via environment variables)
<IfModule mpm_prefork_module>
    StartServers          {{APACHE_START_SERVERS}}
    MinSpareServers       {{APACHE_MIN_SPARE_SERVERS}}
    MaxSpareServers       {{APACHE_MAX_SPARE_SERVERS}}
    MaxRequestWorkers     {{APACHE_MAX_REQUEST_WORKERS}}
    MaxConnectionsPerChild {{APACHE_MAX_CONNECTIONS_PER_CHILD}}
    ServerLimit           {{APACHE_SERVER_LIMIT}}
</IfModule>

# Other general configurations if needed
# Supplemental configuration (optional)
# Include some-other-custom-config.conf
