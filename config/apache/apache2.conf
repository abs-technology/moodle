# Apache HTTP Server Configuration for Absi Technology Moodle
# This file is copied into /etc/apache2/apache2.conf inside the Docker container.

# Global configuration
ServerRoot "/etc/apache2"
ServerName localhost

# Basic configuration
PidFile /var/run/apache2/apache2.pid

# Listen on non-privileged ports for non-root user
Listen 8080
Listen 8443

# Load balancer optimizations
UseCanonicalName Off
UseCanonicalPhysicalPort Off
Timeout 60
KeepAlive On
MaxKeepAliveRequests 1000
KeepAliveTimeout 15

# Worker configuration
User absiuser
Group absiuser

# Global logging configuration
ErrorLog /dev/stderr
LogLevel warn

# Define log format
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

# Load balancer log format with X-Forwarded headers
LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Forwarded-Proto}i\"" combined_lb

# Access log configuration
CustomLog /dev/stdout combined_lb

# Other vhosts access log
Include /etc/apache2/conf-available/other-vhosts-access-log.conf

# Document root
DocumentRoot "/var/www/html"
<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# PHP-FPM configuration (will be updated by setup script)
<FilesMatch \.php$>
    SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
</FilesMatch>

# Include additional configuration files
IncludeOptional /etc/apache2/conf-enabled/*.conf
IncludeOptional /etc/apache2/sites-enabled/*.conf

# Access control
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

# Directory for Apache modules.
# Ensure 'a2enmod' is used in Dockerfile to link these.
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include site-specific configuration files.
# The 000-default.conf will be linked here by 'a2ensite' in Dockerfile.
IncludeOptional sites-enabled/*.conf

# HTTPoxy Fix (important security measure)
<IfModule mod_headers.c>
    RequestHeader unset Proxy
</IfModule>

# Server Tokens (for security, hide Apache version)
ServerTokens Prod

# Mutex configuration
Mutex file:/var/lock/apache2 default

# DefaultType
DefaultType None

# MPM configuration optimized for load balancing
<IfModule mpm_prefork_module>
    StartServers          8
    MinSpareServers       8
    MaxSpareServers      20
    MaxRequestWorkers    256
    MaxConnectionsPerChild 1000
    ServerLimit          256
</IfModule>

# Other general configurations if needed
# Supplemental configuration (optional)
# Include some-other-custom-config.conf
