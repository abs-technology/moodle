<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # Load Balancer Support - Trust proxy headers from Google Cloud
    RemoteIPHeader X-Forwarded-For
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16
    RemoteIPTrustedProxy 130.211.0.0/22
    RemoteIPTrustedProxy 35.191.0.0/16

    # Handle HTTPS termination at load balancer
    <IfModule mod_headers.c>
        SetEnvIf X-Forwarded-Proto "https" HTTPS=on
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
    </IfModule>

    <Directory /var/www/html>
        Options FollowSymLinks MultiViews
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html

        # Enable rewrite engine
      #  RewriteEngine On
      #  RewriteBase /

        # Handle HTTPS termination at load balancer
        RewriteCond %{HTTP:X-Forwarded-Proto} =https
        RewriteRule ^(.*)$ - [E=HTTPS:on]

        # Handle PHP files (will be updated by setup script)
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
        </FilesMatch>

        # Security rules
        RewriteRule ^/phpmyadmin - [L,NC]
        RewriteRule "(\/vendor\/)" - [F]
        RewriteRule "(\/node_modules\/)" - [F]
        RewriteRule "(^|/)\.(?!well-known\/)" - [F]
        RewriteRule "(composer\.json)" - [F]
        RewriteRule "(\.lock)" - [F]
        RewriteRule "(\/environment.xml)" - [F]
        Options -Indexes
        RewriteRule "(\/install.xml)" - [F]
        RewriteRule "(\/README)" - [F]
        RewriteRule "(\/readme)" - [F]
        RewriteRule "(\/moodle_readme)" - [F]
        RewriteRule "(\/upgrade\.txt)" - [F]
        RewriteRule "(phpunit\.xml\.dist)" - [F]
        RewriteRule "(\/tests\/behat\/)" - [F]
        RewriteRule "(\/fixtures\/)" - [F]
        RewriteRule "(\/package\.json)" - [F]
        RewriteRule "(\/Gruntfile\.js)" - [F]
    </Directory>

    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined_lb
</VirtualHost>


