<VirtualHost *:{{APACHE_HTTPS_PORT}}>
    ServerAdmin {{WEB_SERVER_ADMIN}}
    DocumentRoot {{MOODLE_DIR}}

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{SSL_CERT_FILE}}
    SSLCertificateKeyFile {{SSL_KEY_FILE}}

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff

    # Moodle specific configuration
    <Directory {{MOODLE_DIR}}>
        Options FollowSymLinks MultiViews
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html

        # Enable rewrite engine
        RewriteEngine On
        RewriteBase /

        # Handle PHP files (configurable via environment variables)
        <FilesMatch \.php$>
            SetHandler "proxy:unix:{{PHP_FPM_SOCKET}}|fcgi://localhost"
        </FilesMatch>

        # Security rules
        RewriteRule ^/phpmyadmin - [L,NC]
        RewriteRule "(\/vendor\/)" - [F]
        RewriteRule "(\/node_modules\/)" - [F]
        RewriteRule "(^|/)\.(?!well-known\/)" - [F]
        RewriteRule "(composer\.json)" - [F]
        RewriteRule "(\.lock)" - [F]
        RewriteRule "(\/environment.xml)" - [F]
        Options -Indexes
        RewriteRule "(\/install.xml)" - [F]
        RewriteRule "(\/README)" - [F]
        RewriteRule "(\/readme)" - [F]
        RewriteRule "(\/moodle_readme)" - [F]
        RewriteRule "(\/upgrade\.txt)" - [F]
        RewriteRule "(phpunit\.xml\.dist)" - [F]
        RewriteRule "(\/tests\/behat\/)" - [F]
        RewriteRule "(\/fixtures\/)" - [F]
        RewriteRule "(\/package\.json)" - [F]
        RewriteRule "(\/Gruntfile\.js)" - [F]
    </Directory>

    # Logging
    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined_lb

    # Moodle data directory protection
    <Directory {{MOODLE_DATA_DIR}}>
        Require all denied
    </Directory>

    # Hide sensitive files
    <Files ~ "^\.">
        Require all denied
    </Files>

    <Files ~ "config\.php$">
        Require all denied
    </Files>
</VirtualHost> 