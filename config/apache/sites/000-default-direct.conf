<VirtualHost *:{{APACHE_HTTP_PORT}}>
    ServerAdmin {{WEB_SERVER_ADMIN}}
    DocumentRoot {{MOODLE_DIR}}

    # Direct connection mode - No load balancer
    # No RemoteIP or proxy header processing

    <Directory {{MOODLE_DIR}}>
        Options FollowSymLinks MultiViews
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html

        # Enable rewrite engine for basic functionality
        RewriteEngine On
        RewriteBase /

        # Handle PHP files (configurable via environment variables)
        <FilesMatch \.php$>
            SetHandler "proxy:unix:{{PHP_FPM_SOCKET}}|fcgi://localhost"
        </FilesMatch>

        # Security rules
        RewriteRule ^/phpmyadmin - [L,NC]
        RewriteRule "(\/vendor\/)" - [F]
        RewriteRule "(\/node_modules\/)" - [F]
        RewriteRule "(^|/)\.(?!well-known\/)" - [F]
        RewriteRule "(composer\.json)" - [F]
        RewriteRule "(\.lock)" - [F]
        RewriteRule "(\/environment.xml)" - [F]
        Options -Indexes
        RewriteRule "(\/install.xml)" - [F]
        RewriteRule "(\/README)" - [F]
        RewriteRule "(\/readme)" - [F]
        RewriteRule "(\/moodle_readme)" - [F]
        RewriteRule "(\/upgrade\.txt)" - [F]
        RewriteRule "(phpunit\.xml\.dist)" - [F]
        RewriteRule "(\/tests\/behat\/)" - [F]
        RewriteRule "(\/fixtures\/)" - [F]
        RewriteRule "(\/package\.json)" - [F]
        RewriteRule "(\/Gruntfile\.js)" - [F]
    </Directory>

    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined
</VirtualHost>
